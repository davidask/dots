#!/usr/bin/env zsh

set -euo pipefail
BIN_DIR="${0:A:h}"

# This script toggles macOS appearance and propagates the change to terminal tools.
if [[ "$(uname)" != "Darwin" ]]; then
  echo "toggle-appearance only supports macOS." >&2
  exit 1
fi

# AppleInterfaceStyle returns "Dark" only when dark mode is active.
is_dark=false
if defaults read -g AppleInterfaceStyle 2>/dev/null | grep -qi '^Dark$'; then
  is_dark=true
fi

# Flip system appearance and capture the matching Neovim background value.
if [[ "$is_dark" == true ]]; then
  osascript -e 'tell application "System Events" to tell appearance preferences to set dark mode to false'
  echo "Switched to light mode."
else
  osascript -e 'tell application "System Events" to tell appearance preferences to set dark mode to true'
  echo "Switched to dark mode."
fi

# Sync all tool themes/backgrounds to the new system mode.
"$BIN_DIR/sync-appearance"
