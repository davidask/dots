#!/usr/bin/env zsh

set -euo pipefail
BIN_DIR="${0:A:h}"

# This script toggles macOS appearance and propagates the change to terminal tools.
if [[ "$(uname)" != "Darwin" ]]; then
  echo "toggle-appearance only supports macOS." >&2
  exit 1
fi

# AppleInterfaceStyle returns "Dark" only when dark mode is active.
is_dark=false
if defaults read -g AppleInterfaceStyle 2>/dev/null | grep -qi '^Dark$'; then
  is_dark=true
fi

# Flip system appearance and capture the matching Neovim background value.
if [[ "$is_dark" == true ]]; then
  osascript -e 'tell application "System Events" to tell appearance preferences to set dark mode to false'
  nvim_bg="light"
  echo "Switched to light mode."
else
  osascript -e 'tell application "System Events" to tell appearance preferences to set dark mode to true'
  nvim_bg="dark"
  echo "Switched to dark mode."
fi

# Keep Zellij aligned with the new system mode.
"$BIN_DIR/sync-zellij-theme"

# Broadcast :set bg=... to reachable Neovim RPC sockets.
updated=0
while IFS= read -r sock; do
  nvim --server "$sock" --remote-expr "execute('set bg=$nvim_bg | redraw!')" >/dev/null 2>&1 || continue
  updated=$((updated + 1))
done < <(find /tmp /private/tmp /var/folders -type s -name 'nvim.*' 2>/dev/null)

if (( updated > 0 )); then
  echo "Updated $updated running Neovim instance(s)."
else
  echo "No reachable Neovim servers found."
fi
